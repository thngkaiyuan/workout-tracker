<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Prevents double-tap to zoom on buttons, improving responsiveness */
        .touch-manipulation {
            touch-action: manipulation;
        }
        /* Custom gradient styles for headers and cards */
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        /* Simple transition for view changes */
        #app.fade-out {
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        #app.fade-in {
            opacity: 1;
            transition: opacity 0.15s ease-in;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Main application container -->
    <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen"></div>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        const app = document.getElementById('app');
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const today = new Date().getDay();

        // --- Application State ---
        let state = {
            currentView: 'dashboard',
            plans: [],
            workoutHistory: [],
            currentWorkout: null,
            currentExerciseIndex: 0,
            currentSetIndex: 0,
            // Reps-based exercise state
            currentReps: 0,
            currentWeight: 0,
            // Time-based exercise state
            timerState: 'idle', // idle, running
            elapsedTime: 0, // The actual time elapsed in seconds
            timerInterval: null,
            lastDuration: 0, // The record to beat
            // Other state
            selectedPlan: null,
            editingExerciseId: null, // ID of the exercise being edited in the new plan
            newPlan: {
                name: '',
                dayOfWeek: today,
                exercises: []
            },
            newExercise: { name: '', type: 'reps', sets: 3, reps: 10, duration: 60 }
        };

        // --- Data Persistence ---
        function safeGetItem(key) { try { return localStorage.getItem(key); } catch (e) { console.warn(e); return null; } }
        function safeSetItem(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.warn(e); } }

        function loadData() {
            const savedPlans = safeGetItem('workoutPlans');
            if (savedPlans) state.plans = JSON.parse(savedPlans);
            
            const savedHistory = safeGetItem('workoutHistory');
            if (savedHistory) state.workoutHistory = JSON.parse(savedHistory);
        }

        function saveData() {
            safeSetItem('workoutPlans', JSON.stringify(state.plans));
            safeSetItem('workoutHistory', JSON.stringify(state.workoutHistory));
        }

        // --- Business Logic & Helpers ---
        const getTodaysWorkout = () => state.plans.find(plan => plan.dayOfWeek === today);
        const getPlanById = (id) => state.plans.find(p => p.id === id);

        function getLastWeight(exerciseName) {
            const record = state.workoutHistory.slice().reverse().find(r => r.exercise === exerciseName && r.type === 'reps');
            return record ? record.weight : 0;
        }

        function getLastDuration(exerciseName) {
            const record = state.workoutHistory.slice().reverse().find(r => r.exercise === exerciseName && r.type === 'time');
            return record ? record.duration : 0;
        }
        
        function getWorkoutSessions(planName) {
            const sessions = state.workoutHistory
                .filter(record => record.planName === planName)
                .reduce((acc, record) => {
                    const dateKey = new Date(record.date).toLocaleDateString();
                    if (!acc[dateKey]) acc[dateKey] = [];
                    acc[dateKey].push(record);
                    return acc;
                }, {});

            return Object.entries(sessions)
                .sort(([a], [b]) => new Date(b) - new Date(a))
                .map(([date, records]) => {
                    const exercises = records.reduce((acc, record) => {
                        if (!acc[record.exercise]) {
                            acc[record.exercise] = { name: record.exercise, sets: [] };
                        }
                        acc[record.exercise].sets.push(record);
                        acc[record.exercise].sets.sort((a, b) => a.set - b.set);
                        return acc;
                    }, {});
                    return { date, exercises: Object.values(exercises) };
                });
        }

        // --- State Changers & Actions ---
        function navigate(view) {
            if (state.currentView === 'workout' && state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            state.currentView = view;
            render();
        }

        function startWorkout(planId) {
            const plan = getPlanById(planId);
            if (!plan || plan.exercises.length === 0) return;
            
            state.currentWorkout = plan;
            state.currentExerciseIndex = 0;
            state.currentSetIndex = 0;
            
            const firstExercise = plan.exercises[0];
            if (firstExercise.type === 'reps') {
                state.currentReps = firstExercise.reps;
                state.currentWeight = getLastWeight(firstExercise.name);
            } else {
                state.lastDuration = getLastDuration(firstExercise.name);
                state.elapsedTime = 0;
                state.timerState = 'idle';
            }
            navigate('workout');
        }

        function viewPlanHistory(planId) {
            const plan = getPlanById(planId);
            if (!plan) return;
            
            state.selectedPlan = plan;
            navigate('planHistory');
        }
        
        function completeSet() {
            const currentExercise = state.currentWorkout.exercises[state.currentExerciseIndex];
            
            state.workoutHistory.push({
                date: new Date().toISOString(),
                exercise: currentExercise.name,
                set: state.currentSetIndex + 1,
                reps: state.currentReps,
                weight: state.currentWeight,
                planName: state.currentWorkout.name,
                type: 'reps'
            });
            saveData();
            moveToNext();
        }

        function startTimer() {
            state.timerState = 'running';
            const startTime = Date.now();

            state.timerInterval = setInterval(() => {
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                state.elapsedTime = elapsedSeconds;
                render(); 
            }, 100); // Update frequently for smooth decimal display
            render();
        }

        function stopTimer() {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            state.timerState = 'idle';

            const currentExercise = state.currentWorkout.exercises[state.currentExerciseIndex];
            const finalDuration = parseFloat(state.elapsedTime.toFixed(1)); // Save the final elapsed time

            state.workoutHistory.push({
                date: new Date().toISOString(),
                exercise: currentExercise.name,
                set: state.currentSetIndex + 1,
                duration: finalDuration,
                planName: state.currentWorkout.name,
                type: 'time'
            });
            saveData();
            moveToNext();
        }
        
        function moveToNext() {
            const workout = state.currentWorkout;
            const currentExercise = workout.exercises[state.currentExerciseIndex];

            if (state.currentSetIndex < currentExercise.sets - 1) {
                state.currentSetIndex++;
            } else if (state.currentExerciseIndex < workout.exercises.length - 1) {
                state.currentExerciseIndex++;
                state.currentSetIndex = 0;
            } else {
                navigate('workoutComplete');
                return;
            }

            const nextExercise = workout.exercises[state.currentExerciseIndex];
            if (nextExercise.type === 'reps') {
                state.currentReps = nextExercise.reps;
                state.currentWeight = getLastWeight(nextExercise.name);
            } else {
                state.lastDuration = getLastDuration(nextExercise.name);
                state.elapsedTime = 0; // Reset timer for next exercise
            }
            render();
        }

        function saveOrUpdateExercise() {
            if (!state.newExercise.name) return;

            if (state.editingExerciseId !== null) {
                // Update existing exercise
                const index = state.newPlan.exercises.findIndex(ex => ex.id === state.editingExerciseId);
                if (index !== -1) {
                    state.newPlan.exercises[index] = { ...state.newExercise, id: state.editingExerciseId };
                }
            } else {
                // Add new exercise
                state.newPlan.exercises.push({ ...state.newExercise, id: Date.now() });
            }

            // Reset form and editing state
            state.editingExerciseId = null;
            state.newExercise = { name: '', type: 'reps', sets: 3, reps: 10, duration: 60 };
            render();
        }

        function deleteExercise(exerciseId) {
            state.newPlan.exercises = state.newPlan.exercises.filter(ex => ex.id !== exerciseId);
            // If the deleted exercise was being edited, cancel the edit mode.
            if (state.editingExerciseId === exerciseId) {
                cancelEdit();
            } else {
                render();
            }
        }
        function startEditExercise(exerciseId) {
            const exerciseToEdit = state.newPlan.exercises.find(ex => ex.id === exerciseId);
            if (exerciseToEdit) {
                state.editingExerciseId = exerciseId;
                state.newExercise = { ...exerciseToEdit };
                render();
                // Scroll the form into view for a better user experience
                app.querySelector('#add-exercise-form')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        function cancelEdit() {
            state.editingExerciseId = null;
            state.newExercise = { name: '', type: 'reps', sets: 3, reps: 10, duration: 60 };
            render();
        }

        function moveExercise(exerciseId, direction) {
            const exercises = state.newPlan.exercises;
            const index = exercises.findIndex(ex => ex.id === exerciseId);

            if (index === -1) return;

            if (direction === 'up' && index > 0) {
                [exercises[index - 1], exercises[index]] = [exercises[index], exercises[index - 1]];
            } else if (direction === 'down' && index < exercises.length - 1) {
                [exercises[index + 1], exercises[index]] = [exercises[index], exercises[index + 1]];
            }

            render();
        }
        
        function saveNewPlan() {
            if (state.newPlan.name && state.newPlan.exercises.length > 0) {
                state.plans.push({ ...state.newPlan, id: Date.now() });
                state.newPlan = { name: '', dayOfWeek: today, exercises: [] }; // Reset form
                saveData();
                navigate('dashboard');
            }
        }


        // --- Event Delegation ---
        app.addEventListener('click', e => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, id, direction } = target.dataset;

            const actions = {
                'navigate': () => navigate(id),
                'start-workout': () => startWorkout(parseInt(id)),
                'view-plan-history': () => viewPlanHistory(parseInt(id)),
                'complete-set': completeSet,
                'start-timer': startTimer,
                'stop-timer': stopTimer,
                'add-exercise': saveOrUpdateExercise,
                'save-plan': saveNewPlan,
                'delete-exercise': () => deleteExercise(parseInt(id)),
                'move-exercise': () => moveExercise(parseInt(id), direction),
                'start-edit-exercise': () => startEditExercise(parseInt(id)),
                'cancel-edit': cancelEdit,
                'update-reps': () => {
                    state.currentReps = Math.max(0, state.currentReps + parseInt(id));
                    render();
                },
                'update-weight': () => {
                    state.currentWeight = Math.max(0, state.currentWeight + parseInt(id));
                    render();
                },
            };
            
            if (actions[action]) actions[action]();
        });
        
        app.addEventListener('input', e => {
            const { field } = e.target.dataset;
            const value = e.target.type === 'number' ? parseInt(e.target.value) || 0 : e.target.value;

            const fields = {
                'newPlanName': () => state.newPlan.name = value,
                'newPlanDay': () => state.newPlan.dayOfWeek = parseInt(value),
                'newExerciseName': () => state.newExercise.name = value,
                'newExerciseType': () => { state.newExercise.type = value; render(); },
                'newExerciseSets': () => state.newExercise.sets = value,
                'newExerciseReps': () => state.newExercise.reps = value,
                'newExerciseDuration': () => state.newExercise.duration = value,
                'currentReps': () => state.currentReps = value,
                'currentWeight': () => state.currentWeight = value,
            };

            if (fields[field]) fields[field]();
        });


        // --- Render Functions ---
        function renderDashboard() {
            const todaysWorkout = getTodaysWorkout();
            return `
                <div class="gradient-bg text-white p-6 rounded-b-3xl shadow-lg">
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>
                        Workout Tracker
                    </h1>
                    <p class="text-blue-100 mt-1">Today is ${daysOfWeek[today]}</p>
                </div>

                <div class="p-4 md:p-6 space-y-4">
                    ${todaysWorkout ? `
                        <div class="gradient-green text-white p-6 rounded-2xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-lg font-bold">Today's Workout</h2>
                                    <p class="text-green-100 text-sm">${todaysWorkout.name}</p>
                                    <p class="text-green-100 text-xs mt-1">${todaysWorkout.exercises.length} exercises</p>
                                </div>
                                <button data-action="start-workout" data-id="${todaysWorkout.id}" class="bg-white text-green-600 px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg touch-manipulation active:bg-gray-50">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21"></polygon></svg>
                                    Start
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-white p-6 rounded-2xl text-center border">
                            <svg width="32" height="32" class="mx-auto mb-2 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            <p class="text-gray-600">No workout planned for today.</p>
                            <button data-action="navigate" data-id="createPlan" class="mt-3 text-sm bg-blue-500 text-white px-4 py-2 rounded-lg">Create a Plan</button>
                        </div>
                    `}

                    <div class="space-y-3">
                        <h3 class="text-lg font-semibold text-gray-800 px-2">All Workout Plans</h3>
                        ${state.plans.length > 0 ? state.plans.map(plan => `
                            <div class="bg-white p-4 rounded-xl shadow-sm border flex items-center justify-between">
                                <div data-action="view-plan-history" data-id="${plan.id}" class="flex-1 cursor-pointer">
                                    <h4 class="font-semibold text-gray-800">${plan.name}</h4>
                                    <p class="text-sm text-gray-600">${daysOfWeek[plan.dayOfWeek]} • ${plan.exercises.length} exercises</p>
                                </div>
                                <button data-action="start-workout" data-id="${plan.id}" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium touch-manipulation active:bg-blue-600 ml-2">
                                    Start
                                </button>
                            </div>
                        `).join('') : `<p class="text-center text-gray-500 bg-gray-100 p-4 rounded-lg">No plans created yet.</p>`}
                    </div>

                    <button data-action="navigate" data-id="createPlan" class="w-full bg-blue-600 text-white p-4 rounded-xl font-semibold flex items-center justify-center gap-2 touch-manipulation active:bg-blue-700">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add New Plan
                    </button>
                </div>
            `;
        }
        
        function renderPlanHistory() {
            const sessions = getWorkoutSessions(state.selectedPlan.name);
            const plan = state.selectedPlan;

            return `
                <div class="gradient-bg text-white p-6 flex items-center gap-3 sticky top-0 shadow-md">
                    <button data-action="navigate" data-id="dashboard" class="touch-manipulation p-2 -ml-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold">${plan.name}</h1>
                        <p class="text-blue-100 text-sm">${daysOfWeek[plan.dayOfWeek]} • ${plan.exercises.length} exercises</p>
                    </div>
                </div>

                <div class="p-4 md:p-6 space-y-6">
                    <!-- Plan Overview Section -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            Plan Overview
                        </h3>
                        <div class="space-y-2">
                            ${plan.exercises.map(ex => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-800">${ex.name}</p>
                                        <p class="text-sm text-gray-500">${ex.type === 'reps' ? `${ex.sets} sets × ${ex.reps} reps` : `${ex.sets} sets × ${ex.duration}s`}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Workout History Section -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
                            Workout History
                        </h3>
                        ${sessions.length === 0 ? `
                            <div class="bg-white p-6 rounded-xl text-center border mt-2">
                                <svg width="48" height="48" class="mx-auto mb-3 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                                <p class="text-gray-600">No workouts recorded for this plan yet.</p>
                                <button data-action="start-workout" data-id="${plan.id}" class="mt-4 bg-blue-500 text-white px-5 py-2 rounded-lg font-semibold text-sm">Start First Workout</button>
                            </div>
                        ` : `
                            <div class="space-y-4 mt-2">
                                ${sessions.map(session => `
                                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                                        <div class="bg-gray-50 p-4 border-b">
                                            <h3 class="font-semibold text-gray-800">${session.date}</h3>
                                        </div>
                                        <div class="p-4 space-y-4">
                                            ${session.exercises.map(exercise => `
                                                <div>
                                                    <h4 class="font-medium text-gray-800 mb-2">${exercise.name}</h4>
                                                    <div class="grid grid-cols-1 gap-2">
                                                        ${exercise.sets.map(set => `
                                                            <div class="flex justify-between items-center py-1 px-3 bg-gray-50 rounded text-sm">
                                                                <span class="text-gray-600">Set ${set.set}</span>
                                                                <span class="font-medium">${set.type === 'reps' ? `${set.reps} reps × ${set.weight} lbs` : `${set.duration}s`}</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderCreatePlan() {
            const isEditing = state.editingExerciseId !== null;
            return `
                <div class="gradient-bg text-white p-6 flex items-center gap-3">
                    <button data-action="navigate" data-id="dashboard" class="touch-manipulation p-2 -ml-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>
                    </button>
                    <h1 class="text-xl font-bold">Create New Plan</h1>
                </div>
                <div class="p-4 md:p-6 space-y-6">
                    <div class="space-y-4 bg-white p-4 rounded-xl border">
                        <div>
                            <label for="plan-name" class="block text-sm font-medium text-gray-700 mb-1">Plan Name</label>
                            <input id="plan-name" type="text" data-field="newPlanName" value="${state.newPlan.name}" class="w-full p-3 border rounded-lg" placeholder="e.g., Push Day">
                        </div>
                        <div>
                            <label for="plan-day" class="block text-sm font-medium text-gray-700 mb-1">Day of Week</label>
                            <select id="plan-day" data-field="newPlanDay" class="w-full p-3 border rounded-lg bg-white">
                                ${daysOfWeek.map((day, index) => `<option value="${index}" ${index === state.newPlan.dayOfWeek ? 'selected' : ''}>${day}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div id="add-exercise-form" class="bg-white p-4 rounded-xl shadow-sm border scroll-mt-4">
                        <h3 class="font-semibold text-gray-800 mb-4">${isEditing ? 'Edit Exercise' : 'Add Exercise'}</h3>
                        <div class="space-y-3">
                            <input type="text" data-field="newExerciseName" value="${state.newExercise.name}" class="w-full p-3 border rounded-lg" placeholder="Exercise name">
                            
                            <div>
                                <label for="exercise-type" class="block text-sm text-gray-600 mb-1">Exercise Type</label>
                                <select id="exercise-type" data-field="newExerciseType" class="w-full p-3 border rounded-lg bg-white">
                                    <option value="reps" ${state.newExercise.type === 'reps' ? 'selected' : ''}>Reps & Weight</option>
                                    <option value="time" ${state.newExercise.type === 'time' ? 'selected' : ''}>Time</option>
                                </select>
                            </div>

                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label for="exercise-sets" class="block text-sm text-gray-600 mb-1">Sets</label>
                                    <input id="exercise-sets" type="number" data-field="newExerciseSets" value="${state.newExercise.sets}" class="w-full p-2 border rounded" min="1">
                                </div>
                                ${state.newExercise.type === 'reps' ? `
                                <div class="flex-1">
                                    <label for="exercise-reps" class="block text-sm text-gray-600 mb-1">Reps</label>
                                    <input id="exercise-reps" type="number" data-field="newExerciseReps" value="${state.newExercise.reps}" class="w-full p-2 border rounded" min="1">
                                </div>
                                ` : `
                                <div class="flex-1">
                                    <label for="exercise-duration" class="block text-sm text-gray-600 mb-1">Duration (s)</label>
                                    <input id="exercise-duration" type="number" data-field="newExerciseDuration" value="${state.newExercise.duration}" class="w-full p-2 border rounded" min="1">
                                </div>
                                `}
                            </div>
                            <div class="flex gap-2 pt-2">
                                <button data-action="add-exercise" class="w-full bg-green-500 text-white p-3 rounded-lg font-medium touch-manipulation active:bg-green-600">${isEditing ? 'Update Exercise' : 'Add Exercise'}</button>
                                ${isEditing ? `
                                    <button data-action="cancel-edit" class="w-full bg-gray-200 text-gray-800 p-3 rounded-lg font-medium touch-manipulation active:bg-gray-300">Cancel</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${state.newPlan.exercises.length > 0 ? `
                        <div class="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-gray-800 mb-3">Exercises (${state.newPlan.exercises.length})</h3>
                            <div class="space-y-2">
                                ${state.newPlan.exercises.map((ex, index) => `
                                    <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200 shadow-sm">
                                        <div>
                                            <p class="font-medium text-gray-800">${ex.name}</p>
                                            <p class="text-sm text-gray-500">${ex.type === 'reps' ? `${ex.sets} sets × ${ex.reps} reps` : `${ex.sets} sets × ${ex.duration}s`}</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex flex-col -space-y-1">
                                                <button data-action="move-exercise" data-id="${ex.id}" data-direction="up" class="p-1 text-gray-400 hover:text-blue-600 ${index === 0 ? 'opacity-25 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                                </button>
                                                <button data-action="move-exercise" data-id="${ex.id}" data-direction="down" class="p-1 text-gray-400 hover:text-blue-600 ${index === state.newPlan.exercises.length - 1 ? 'opacity-25 cursor-not-allowed' : ''}" ${index === state.newPlan.exercises.length - 1 ? 'disabled' : ''}>
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                                </button>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button data-action="start-edit-exercise" data-id="${ex.id}" class="p-2 text-gray-400 hover:text-blue-600 focus:outline-none touch-manipulation">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                                                </button>
                                                <button data-action="delete-exercise" data-id="${ex.id}" class="p-2 text-gray-400 hover:text-red-600 focus:outline-none touch-manipulation">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <button data-action="save-plan" class="w-full bg-blue-600 text-white p-4 rounded-xl font-semibold touch-manipulation active:bg-blue-700">Save Plan</button>
                </div>
            `;
        }

        function renderWorkout() {
            const currentExercise = state.currentWorkout.exercises[state.currentExerciseIndex];
            const isReps = currentExercise.type === 'reps';
            
            let exerciseUI;

            if (isReps) {
                exerciseUI = `
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm border"><label class="block text-sm font-medium text-gray-700 mb-2">Reps</label><div class="flex items-center justify-center space-x-3"><button data-action="update-reps" data-id="-1" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button><input type="number" data-field="currentReps" value="${state.currentReps}" class="w-24 text-center text-2xl font-bold border-b-2 py-2 px-3" min="0"><button data-action="update-reps" data-id="1" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div></div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border"><label class="block text-sm font-medium text-gray-700 mb-2">Weight (lbs)</label><div class="flex items-center justify-center space-x-3"><button data-action="update-weight" data-id="-1" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button><input type="number" data-field="currentWeight" value="${state.currentWeight}" class="w-24 text-center text-2xl font-bold border-b-2 py-2 px-3" min="0"><button data-action="update-weight" data-id="1" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div></div>
                    </div>
                    <button data-action="complete-set" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 touch-manipulation active:bg-green-700">Complete Set</button>
                `;
            } else { // Time-based exercise
                const recordDuration = state.lastDuration > 0 ? state.lastDuration : currentExercise.duration;
                const isBeatingRecord = state.elapsedTime > recordDuration;
                const timerDisplay = state.elapsedTime.toFixed(1) + 's';

                exerciseUI = `
                    <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                        <p class="text-sm font-medium text-gray-500">Record: ${recordDuration}s</p>
                        <p class="text-6xl font-bold my-4 ${isBeatingRecord ? 'text-green-500' : ''}">${timerDisplay}</p>
                        ${state.timerState === 'idle' && state.lastDuration > 0 ? `<p class="font-semibold text-blue-600 text-lg animate-pulse">BEAT IT!</p>` : ''}
                        ${isBeatingRecord ? `<p class="font-semibold text-green-600 text-lg">NEW RECORD!</p>` : ''}
                    </div>
                    ${state.timerState === 'running' 
                        ? `<button data-action="stop-timer" class="w-full bg-red-500 text-white p-4 rounded-xl font-bold text-lg touch-manipulation">Done</button>`
                        : `<button data-action="start-timer" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold text-lg touch-manipulation">Start</button>`
                    }
                `;
            }

            return `
                <div class="gradient-green text-white p-6 sticky top-0 shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <button data-action="navigate" data-id="dashboard" class="touch-manipulation p-2 -ml-2"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg></button>
                        <h1 class="text-xl font-bold">${state.currentWorkout.name}</h1>
                        <div class="w-10"></div>
                    </div>
                </div>
                <div class="p-4 md:p-6 space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">${currentExercise.name}</h2>
                        <p class="text-gray-600">Set ${state.currentSetIndex + 1} of ${currentExercise.sets}</p>
                    </div>
                    ${exerciseUI}
                </div>
            `;
        }
        
        function renderWorkoutComplete() {
            return `
                <div class="gradient-green text-white p-6 text-center">
                    <div class="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
                        <svg width="32" height="32" class="text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                    </div>
                    <h1 class="text-2xl font-bold mb-2">Workout Complete!</h1>
                    <p class="text-green-100">Great job finishing ${state.currentWorkout.name}.</p>
                </div>
                <div class="p-4 md:p-6 space-y-3">
                    <button data-action="navigate" data-id="dashboard" class="w-full bg-blue-600 text-white p-4 rounded-xl font-semibold touch-manipulation active:bg-blue-700">Back to Dashboard</button>
                    <button data-action="start-workout" data-id="${state.currentWorkout.id}" class="w-full bg-gray-200 text-gray-800 p-4 rounded-xl font-semibold flex items-center justify-center gap-2 touch-manipulation active:bg-gray-300">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1,4 1,10 7,10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        Repeat Workout
                    </button>
                </div>
            `;
        }

        function render() {
            const viewMap = {
                'dashboard': renderDashboard,
                'createPlan': renderCreatePlan,
                'planHistory': renderPlanHistory,
                'workout': renderWorkout,
                'workoutComplete': renderWorkoutComplete,
            };
            const newHtml = (viewMap[state.currentView] || viewMap['dashboard'])();
            
            app.classList.add('fade-out');
            setTimeout(() => {
                app.innerHTML = newHtml;
                app.classList.remove('fade-out');
                app.classList.add('fade-in');
            }, 150);
        }

        function init() {
            loadData();
            render();
        }
        
        init();
    </script>
</body>
</html>
