<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Prevents double-tap to zoom on buttons, improving responsiveness */
        .touch-manipulation {
            touch-action: manipulation;
        }
        /* Custom gradient styles for headers and cards */
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        /* Simple transition for view changes */
        #app.fade-out {
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        #app.fade-in {
            opacity: 1;
            transition: opacity 0.15s ease-in;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Main application container -->
    <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen"></div>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        const app = document.getElementById('app');
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const today = new Date().getDay();

        // --- Application State ---
        // A single source of truth for the entire application's data.
        let state = {
            currentView: 'dashboard', // dashboard, createPlan, workout, workoutComplete, planHistory
            plans: [],
            workoutHistory: [],
            currentWorkout: null,
            currentExerciseIndex: 0,
            currentSetIndex: 0,
            currentReps: 0,
            currentWeight: 0,
            selectedPlan: null,
            // State for the plan creation form
            newPlan: {
                name: '',
                dayOfWeek: today,
                exercises: []
            },
            // State for the new exercise form within the plan creation view
            newExercise: { name: '', sets: 3, reps: 10 }
        };

        // --- Data Persistence ---
        // Safely interact with localStorage, handling potential errors.
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (error) {
                console.warn('localStorage not available:', error);
                return null;
            }
        }

        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (error) {
                console.warn('localStorage not available:', error);
            }
        }

        // Load data from localStorage into the state object on startup.
        function loadData() {
            const savedPlans = safeGetItem('workoutPlans');
            if (savedPlans) state.plans = JSON.parse(savedPlans);
            
            const savedHistory = safeGetItem('workoutHistory');
            if (savedHistory) state.workoutHistory = JSON.parse(savedHistory);
        }

        // Save the current state to localStorage.
        function saveData() {
            safeSetItem('workoutPlans', JSON.stringify(state.plans));
            safeSetItem('workoutHistory', JSON.stringify(state.workoutHistory));
        }

        // --- Business Logic & Helpers ---
        const getTodaysWorkout = () => state.plans.find(plan => plan.dayOfWeek === today);
        const getPlanById = (id) => state.plans.find(p => p.id === id);

        // Finds the last recorded weight for a given exercise.
        function getLastWeight(exerciseName) {
            const lastRecord = state.workoutHistory
                .slice() // Create a copy to avoid mutating the original array
                .reverse()
                .find(record => record.exercise === exerciseName);
            return lastRecord ? lastRecord.weight : 0;
        }
        
        // Groups workout history by date for a specific plan.
        function getWorkoutSessions(planName) {
            const sessions = state.workoutHistory
                .filter(record => record.planName === planName)
                .reduce((acc, record) => {
                    const dateKey = new Date(record.date).toLocaleDateString();
                    if (!acc[dateKey]) acc[dateKey] = [];
                    acc[dateKey].push(record);
                    return acc;
                }, {});

            return Object.entries(sessions)
                .sort(([a], [b]) => new Date(b) - new Date(a))
                .map(([date, records]) => {
                    const exercises = records.reduce((acc, record) => {
                        if (!acc[record.exercise]) {
                            acc[record.exercise] = { name: record.exercise, sets: [] };
                        }
                        acc[record.exercise].sets.push(record);
                        acc[record.exercise].sets.sort((a, b) => a.set - b.set);
                        return acc;
                    }, {});
                    return { date, exercises: Object.values(exercises) };
                });
        }

        // --- State Changers & Actions ---
        // These functions modify the state and trigger a re-render.
        
        function navigate(view) {
            state.currentView = view;
            render();
        }

        function startWorkout(planId) {
            const plan = getPlanById(planId);
            if (!plan) return;
            
            state.currentWorkout = plan;
            state.currentExerciseIndex = 0;
            state.currentSetIndex = 0;
            const firstExercise = plan.exercises[0];
            state.currentReps = firstExercise.reps;
            state.currentWeight = getLastWeight(firstExercise.name);
            navigate('workout');
        }

        function viewPlanHistory(planId) {
            const plan = getPlanById(planId);
            if (!plan) return;
            
            state.selectedPlan = plan;
            navigate('planHistory');
        }
        
        function deletePlan(planId) {
            if (confirm('Are you sure you want to delete this plan?')) {
                state.plans = state.plans.filter(p => p.id !== planId);
                saveData();
                render();
            }
        }

        function completeSet() {
            const currentExercise = state.currentWorkout.exercises[state.currentExerciseIndex];
            
            state.workoutHistory.push({
                date: new Date().toISOString(),
                exercise: currentExercise.name,
                set: state.currentSetIndex + 1,
                reps: state.currentReps,
                weight: state.currentWeight,
                planName: state.currentWorkout.name
            });
            saveData();

            if (state.currentSetIndex < currentExercise.sets - 1) {
                state.currentSetIndex++;
            } else if (state.currentExerciseIndex < state.currentWorkout.exercises.length - 1) {
                state.currentExerciseIndex++;
                state.currentSetIndex = 0;
                const nextExercise = state.currentWorkout.exercises[state.currentExerciseIndex];
                state.currentReps = nextExercise.reps;
                state.currentWeight = getLastWeight(nextExercise.name);
            } else {
                navigate('workoutComplete');
                return;
            }
            render();
        }

        function addExerciseToNewPlan() {
            if (state.newExercise.name) {
                state.newPlan.exercises.push({ ...state.newExercise, id: Date.now() });
                state.newExercise = { name: '', sets: 3, reps: 10 }; // Reset form
                render();
            }
        }
        
        function removeExerciseFromNewPlan(exerciseId) {
            state.newPlan.exercises = state.newPlan.exercises.filter(ex => ex.id !== exerciseId);
            render();
        }

        function saveNewPlan() {
            if (state.newPlan.name && state.newPlan.exercises.length > 0) {
                state.plans.push({ ...state.newPlan, id: Date.now() });
                state.newPlan = { name: '', dayOfWeek: today, exercises: [] }; // Reset form
                saveData();
                navigate('dashboard');
            }
        }
        
        // --- Event Delegation ---
        // A single event listener manages all interactions, improving performance.
        app.addEventListener('click', e => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const { action, id } = actionTarget.dataset;

            switch (action) {
                case 'navigate': navigate(id); break;
                case 'start-workout': startWorkout(parseInt(id)); break;
                case 'view-plan-history': viewPlanHistory(parseInt(id)); break;
                case 'delete-plan': deletePlan(parseInt(id)); break;
                case 'complete-set': completeSet(); break;
                case 'add-exercise': addExerciseToNewPlan(); break;
                case 'remove-exercise': removeExerciseFromNewPlan(parseInt(id)); break;
                case 'save-plan': saveNewPlan(); break;
                case 'update-reps':
                    state.currentReps = Math.max(0, state.currentReps + parseInt(id));
                    render();
                    break;
                case 'update-weight':
                    state.currentWeight = Math.max(0, state.currentWeight + parseInt(id));
                    render();
                    break;
            }
        });
        
        // Handles form inputs, updating state in real-time.
        app.addEventListener('input', e => {
            const { field, value } = e.target.dataset;
            const inputValue = e.target.type === 'number' ? parseInt(e.target.value) : e.target.value;

            switch (field) {
                case 'newPlanName': state.newPlan.name = inputValue; break;
                case 'newPlanDay': state.newPlan.dayOfWeek = parseInt(inputValue); break;
                case 'newExerciseName': state.newExercise.name = inputValue; break;
                case 'newExerciseSets': state.newExercise.sets = parseInt(inputValue) || 1; break;
                case 'newExerciseReps': state.newExercise.reps = parseInt(inputValue) || 1; break;
                case 'currentReps': state.currentReps = parseInt(inputValue) || 0; break;
                case 'currentWeight': state.currentWeight = parseInt(inputValue) || 0; break;
            }
        });


        // --- Render Functions ---
        // Each function generates the HTML for a specific view.
        
        function renderDashboard() {
            const todaysWorkout = getTodaysWorkout();
            return `
                <div class="gradient-bg text-white p-6 rounded-b-3xl shadow-lg">
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>
                        Workout Tracker
                    </h1>
                    <p class="text-blue-100 mt-1">Today is ${daysOfWeek[today]}</p>
                </div>

                <div class="p-4 md:p-6 space-y-4">
                    ${todaysWorkout ? `
                        <div class="gradient-green text-white p-6 rounded-2xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-lg font-bold">Today's Workout</h2>
                                    <p class="text-green-100 text-sm">${todaysWorkout.name}</p>
                                    <p class="text-green-100 text-xs mt-1">${todaysWorkout.exercises.length} exercises</p>
                                </div>
                                <button data-action="start-workout" data-id="${todaysWorkout.id}" class="bg-white text-green-600 px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg touch-manipulation active:bg-gray-50">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21"></polygon></svg>
                                    Start
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-white p-6 rounded-2xl text-center border">
                            <svg width="32" height="32" class="mx-auto mb-2 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            <p class="text-gray-600">No workout planned for today.</p>
                            <button data-action="navigate" data-id="createPlan" class="mt-3 text-sm bg-blue-500 text-white px-4 py-2 rounded-lg">Create a Plan</button>
                        </div>
                    `}

                    <div class="space-y-3">
                        <h3 class="text-lg font-semibold text-gray-800 px-2">All Workout Plans</h3>
                        ${state.plans.length > 0 ? state.plans.map(plan => `
                            <div class="bg-white p-4 rounded-xl shadow-sm border flex items-center justify-between">
                                <div data-action="view-plan-history" data-id="${plan.id}" class="flex-1 cursor-pointer">
                                    <h4 class="font-semibold text-gray-800">${plan.name}</h4>
                                    <p class="text-sm text-gray-600">${daysOfWeek[plan.dayOfWeek]} • ${plan.exercises.length} exercises</p>
                                </div>
                                <button data-action="start-workout" data-id="${plan.id}" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium touch-manipulation active:bg-blue-600 ml-2">
                                    Start
                                </button>
                            </div>
                        `).join('') : `<p class="text-center text-gray-500 bg-gray-100 p-4 rounded-lg">No plans created yet.</p>`}
                    </div>

                    <button data-action="navigate" data-id="createPlan" class="w-full bg-blue-600 text-white p-4 rounded-xl font-semibold flex items-center justify-center gap-2 touch-manipulation active:bg-blue-700">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add New Plan
                    </button>
                </div>
            `;
        }
        
        function renderPlanHistory() {
            const sessions = getWorkoutSessions(state.selectedPlan.name);
            return `
                <div class="gradient-bg text-white p-6 flex items-center gap-3 sticky top-0 shadow-md">
                    <button data-action="navigate" data-id="dashboard" class="touch-manipulation p-2 -ml-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold">${state.selectedPlan.name}</h1>
                        <p class="text-blue-100 text-sm">${sessions.length} workout${sessions.length !== 1 ? 's' : ''} completed</p>
                    </div>
                </div>

                <div class="p-4 md:p-6 space-y-4">
                    ${sessions.length === 0 ? `
                        <div class="bg-white p-6 rounded-xl text-center border">
                            <svg width="48" height="48" class="mx-auto mb-3 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                            <p class="text-gray-600">No workouts recorded for this plan yet.</p>
                        </div>
                    ` : sessions.map(session => `
                        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <div class="bg-gray-50 p-4 border-b">
                                <h3 class="font-semibold text-gray-800">${session.date}</h3>
                            </div>
                            <div class="p-4 space-y-4">
                                ${session.exercises.map(exercise => `
                                    <div>
                                        <h4 class="font-medium text-gray-800 mb-2">${exercise.name}</h4>
                                        <div class="grid grid-cols-1 gap-2">
                                            ${exercise.sets.map(set => `
                                                <div class="flex justify-between items-center py-1 px-3 bg-gray-50 rounded text-sm">
                                                    <span class="text-gray-600">Set ${set.set}</span>
                                                    <span class="font-medium">${set.reps} reps × ${set.weight} lbs</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}

                    <div class="flex gap-2">
                        <button data-action="delete-plan" data-id="${state.selectedPlan.id}" class="w-1/2 bg-red-500 text-white p-4 rounded-xl font-semibold touch-manipulation active:bg-red-600">Delete</button>
                        <button data-action="start-workout" data-id="${state.selectedPlan.id}" class="w-1/2 bg-green-600 text-white p-4 rounded-xl font-semibold touch-manipulation active:bg-green-700">Start</button>
                    </div>
                </div>
            `;
        }

        function renderCreatePlan() {
            return `
                <div class="gradient-bg text-white p-6 flex items-center gap-3">
                    <button data-action="navigate" data-id="dashboard" class="touch-manipulation p-2 -ml-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>
                    </button>
                    <h1 class="text-xl font-bold">Create New Plan</h1>
                </div>

                <div class="p-4 md:p-6 space-y-6">
                    <div class="space-y-4 bg-white p-4 rounded-xl border">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Name</label>
                            <input type="text" data-field="newPlanName" value="${state.newPlan.name}" class="w-full p-3 border rounded-lg" placeholder="e.g., Push Day">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day of Week</label>
                            <select data-field="newPlanDay" class="w-full p-3 border rounded-lg bg-white">
                                ${daysOfWeek.map((day, index) => `<option value="${index}" ${index === state.newPlan.dayOfWeek ? 'selected' : ''}>${day}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border">
                        <h3 class="font-semibold text-gray-800 mb-4">Add Exercise</h3>
                        <div class="space-y-3">
                            <input type="text" data-field="newExerciseName" value="${state.newExercise.name}" class="w-full p-3 border rounded-lg" placeholder="Exercise name">
                            <div class="flex gap-3">
                                <div class="flex-1"><label class="block text-sm text-gray-600 mb-1">Sets</label><input type="number" data-field="newExerciseSets" value="${state.newExercise.sets}" class="w-full p-2 border rounded" min="1"></div>
                                <div class="flex-1"><label class="block text-sm text-gray-600 mb-1">Reps</label><input type="number" data-field="newExerciseReps" value="${state.newExercise.reps}" class="w-full p-2 border rounded" min="1"></div>
                            </div>
                            <button data-action="add-exercise" class="w-full bg-green-500 text-white p-2 rounded-lg font-medium touch-manipulation active:bg-green-600">Add Exercise</button>
                        </div>
                    </div>

                    ${state.newPlan.exercises.length > 0 ? `
                        <div class="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-gray-800 mb-3">Exercises (${state.newPlan.exercises.length})</h3>
                            <div class="space-y-2">
                                ${state.newPlan.exercises.map(ex => `
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                        <div>
                                            <span class="font-medium">${ex.name}</span>
                                            <span class="text-sm text-gray-600 ml-2">${ex.sets} × ${ex.reps}</span>
                                        </div>
                                        <button data-action="remove-exercise" data-id="${ex.id}" class="text-red-500 p-1">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <button data-action="save-plan" class="w-full bg-blue-600 text-white p-4 rounded-xl font-semibold touch-manipulation active:bg-blue-700">Save Plan</button>
                </div>
            `;
        }

        function renderWorkout() {
            const currentExercise = state.currentWorkout.exercises[state.currentExerciseIndex];
            const totalSetsInWorkout = state.currentWorkout.exercises.reduce((sum, ex) => sum + ex.sets, 0);
            const setsCompletedInPreviousExercises = state.currentWorkout.exercises.slice(0, state.currentExerciseIndex).reduce((sum, ex) => sum + ex.sets, 0);
            const totalSetsCompleted = setsCompletedInPreviousExercises + state.currentSetIndex;
            const progress = (totalSetsCompleted / totalSetsInWorkout) * 100;

            return `
                <div class="gradient-green text-white p-6 sticky top-0 shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <button data-action="navigate" data-id="dashboard" class="touch-manipulation p-2 -ml-2"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg></button>
                        <h1 class="text-xl font-bold">${state.currentWorkout.name}</h1>
                        <div class="w-10"></div>
                    </div>
                    <div class="bg-green-700 rounded-full h-2"><div class="bg-white rounded-full h-2 transition-all duration-300" style="width: ${progress}%"></div></div>
                </div>

                <div class="p-4 md:p-6 space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">${currentExercise.name}</h2>
                        <p class="text-gray-600">Set ${state.currentSetIndex + 1} of ${currentExercise.sets}</p>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm border"><label class="block text-sm font-medium text-gray-700 mb-2">Reps</label><div class="flex items-center justify-center space-x-3"><button data-action="update-reps" data-id="-1" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button><input type="number" data-field="currentReps" value="${state.currentReps}" class="w-24 text-center text-2xl font-bold border-b-2 py-2 px-3" min="0"><button data-action="update-reps" data-id="1" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div></div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border"><label class="block text-sm font-medium text-gray-700 mb-2">Weight (lbs)</label><div class="flex items-center justify-center space-x-3"><button data-action="update-weight" data-id="-5" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button><input type="number" data-field="currentWeight" value="${state.currentWeight}" class="w-24 text-center text-2xl font-bold border-b-2 py-2 px-3" min="0"><button data-action="update-weight" data-id="5" class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg font-bold touch-manipulation active:bg-blue-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div></div>
                    </div>

                    <button data-action="complete-set" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 touch-manipulation active:bg-green-700">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                        Complete Set
                    </button>
                </div>
            `;
        }
        
        function renderWorkoutComplete() {
            return `
                <div class="gradient-green text-white p-6 text-center">
                    <div class="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
                        <svg width="32" height="32" class="text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                    </div>
                    <h1 class="text-2xl font-bold mb-2">Workout Complete!</h1>
                    <p class="text-green-100">Great job finishing ${state.currentWorkout.name}.</p>
                </div>
                <div class="p-4 md:p-6 space-y-3">
                    <button data-action="navigate" data-id="dashboard" class="w-full bg-blue-600 text-white p-4 rounded-xl font-semibold touch-manipulation active:bg-blue-700">Back to Dashboard</button>
                    <button data-action="start-workout" data-id="${state.currentWorkout.id}" class="w-full bg-gray-200 text-gray-800 p-4 rounded-xl font-semibold flex items-center justify-center gap-2 touch-manipulation active:bg-gray-300">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1,4 1,10 7,10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        Repeat Workout
                    </button>
                </div>
            `;
        }

        // --- Main Render Function ---
        // The heart of the UI, which decides which view to show.
        // It now includes a fade effect for smoother transitions.
        function render() {
            const viewMap = {
                'dashboard': renderDashboard,
                'createPlan': renderCreatePlan,
                'planHistory': renderPlanHistory,
                'workout': renderWorkout,
                'workoutComplete': renderWorkoutComplete,
            };
            const newHtml = (viewMap[state.currentView] || viewMap['dashboard'])();
            
            // Fade out, update content, then fade in
            app.classList.add('fade-out');
            setTimeout(() => {
                app.innerHTML = newHtml;
                app.classList.remove('fade-out');
                app.classList.add('fade-in');
            }, 150);
        }

        // --- App Initialization ---
        function init() {
            loadData();
            render();
        }

        // Start the app
        init();
    </script>
</body>
</html>
